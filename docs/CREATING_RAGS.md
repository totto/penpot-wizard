# Creating RAG Tools

This guide explains how to create and add RAG (Retrieval-Augmented Generation) tools to Penpot Wizard. RAG tools search vector databases to retrieve relevant documentation or knowledge for the AI.

## Overview

RAG tools use [Orama](https://docs.oramasearch.com/) for vector search. The database files are generated by a separate project, **orama-persistence-generator**, and served from `penpot-wizard/public/`.

## Embedding Models

| Model | Use Case | API Key | Search Mode |
|-------|-----------|---------|-------------|
| `orama` | Browser embeddings at search time | Not required | Hybrid (term + vector) |
| `openai` | Precomputed embeddings | Required (OpenRouter) | Vector only |

- **Orama**: Embeddings are generated on-the-fly when searching. No API key needed. Good for Penpot docs, design styles.
- **OpenAI**: Embeddings are precomputed during generation. Requires API key at search time for query embeddings. Use for larger datasets or when quality matters more.

## Using orama-persistence-generator

The [orama-persistence-generator](https://github.com/axelseis/orama-persistence-generator) project generates the `.zip` files. It should be a sibling directory to `penpot-wizard`.

### Installation

```bash
cd orama-persistence-generator
npm install
cp env.example .env
# Edit .env and set OPENAI_API_KEY (required for OpenAI embeddings)
```

### Existing Configs

| Config | Output File | Embedding | Source |
|--------|-------------|-----------|--------|
| config.penpotRAG.js | penpotRagToolContents.zip | orama | ../penpot/docs/user-guide |
| config.stylesRAG.js | designRagToolContents.zip | orama | ../MATERIAL/stylesRAGv3 |

### Generate Files

```bash
# Single config
npm run generate:penpot
npm run generate:styles

# Both
npm run generate:all

# Or run directly
node generate-embeddings.js config.penpotRAG.js
```

Output is written to `penpot-wizard/public/` by default.

## Adding a RAG Tool in penpot-wizard

1. **Ensure the `.zip` file exists** in `public/` (e.g. `public/my-knowledge-base.zip`).

2. **Add the tool** in `src/assets/ragTools.js`:

```javascript
import { z } from 'zod';
import { initializeOramaDb, searchOramaDb } from '@/utils/ragUtils';
import { ToolResponse } from '@/types/types';

const myRagTool = {
  id: 'my-knowledge-rag',
  name: 'MyKnowledgeRagTool',
  inputSchema: z.object({
    query: z.string().describe('The search query'),
  }),
  description: `
    Use this tool to search [your knowledge base].
    IMPORTANT: All queries must be in English.
    Include specific technical terms in your queries.
  `,
  function: async ({ query }) => {
    try {
      const dbInstance = await initializeOramaDb('my-knowledge-base.zip', 'orama');
      const results = await searchOramaDb(query, {
        dbInstance,
        limit: 10,
        similarity: 0.85,
        embeddingModel: 'orama',
      });
      return {
        ...ToolResponse,
        success: true,
        message: `Found ${results.length} relevant sections.`,
        payload: { results, query },
      };
    } catch (error) {
      return {
        ...ToolResponse,
        success: false,
        message: 'Search failed. Please try again.',
        payload: { error: error.message, query },
      };
    }
  },
};

export const ragTools = [penpotUserGuideRag, designStylesRag, myRagTool];
```

3. **For OpenAI embeddings** (precomputed), pass API key and model:

```javascript
import { $openrouterApiKey } from '@/stores/settingsStore';

// In function:
const dbInstance = await initializeOramaDb('my-knowledge-base.zip', 'openai');
const apiKey = $openrouterApiKey.get();
const results = await searchOramaDb(query, {
  dbInstance,
  limit: 5,
  similarity: 0.25,
  embeddingModel: 'openai',
  apiKey,
  modelId: 'openai/text-embedding-3-large',
});
```

4. **Register with a director agent** in `directorAgents.js`:

```javascript
toolIds: ['penpot-user-guide-rag', 'my-knowledge-rag', ...]
```

## Creating a RAG from Scratch

1. **Create a config** in orama-persistence-generator, e.g. `config.myRAG.js`:

```javascript
const config = {
  docsPath: '../my-docs',           // Source directory
  docsPattern: '**/*.{html,md}',    // File pattern
  outputDir: '../penpot-wizard/public',
  outputFilename: 'myRagContents.zip',
  embeddingModel: 'orama',          // or 'openai'
  baseUrl: 'https://example.com/docs/',
};

export default config;
```

2. **Add a npm script** in orama-persistence-generator `package.json`:

```json
"generate:myrag": "node generate-embeddings.js config.myRAG.js"
```

3. **Run the generator**:

```bash
npm run generate:myrag
```

4. **Add the RAG tool** in `src/assets/ragTools.js` as shown above.

## Query Optimization

- **Expand queries**: Include technical terms, not just natural language.
- **Use English**: RAG tools typically work best with English queries.
- **Be specific**: "path tool bezier curves" is better than "draw shapes".
